{{- $rawCollection := .Get "collection" | default (strings.TrimPrefix "photos/" .Page.File.Dir) -}}
{{- $collection := $rawCollection | strings.TrimSuffix "/" -}}
{{- $batchSize := .Get "batchSize" | default 12 -}}
{{- $columns := .Get "columns" | default "md:grid-cols-3 lg:grid-cols-4" -}}

{{- /* Find images - use assets folder for processing */ -}}
{{- $assetsPath := printf "assets/images/photos/%s" $collection -}}
{{- $images := slice -}}

{{- /* Read images from assets folder */ -}}
{{- with (readDir $assetsPath) -}}
  {{- range . -}}
    {{- if and (not .IsDir) (in (slice ".jpg" ".jpeg" ".png" ".webp") (path.Ext .Name | lower)) -}}
      {{- $images = $images | append . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Load optional metadata */ -}}
{{- $metadata := dict -}}
{{- $metadataFile := printf "content/photos/%s/metadata" $collection -}}
{{- $yamlPath := printf "%s.yaml" $metadataFile -}}
{{- $ymlPath := printf "%s.yml" $metadataFile -}}
{{- $jsonPath := printf "%s.json" $metadataFile -}}
{{- $tomlPath := printf "%s.toml" $metadataFile -}}

{{- if fileExists $yamlPath -}}
  {{- $metadata = readFile $yamlPath | transform.Unmarshal -}}
{{- else if fileExists $ymlPath -}}
  {{- $metadata = readFile $ymlPath | transform.Unmarshal -}}
{{- else if fileExists $jsonPath -}}
  {{- $metadata = readFile $jsonPath | transform.Unmarshal -}}
{{- else if fileExists $tomlPath -}}
  {{- $metadata = readFile $tomlPath | transform.Unmarshal -}}
{{- end -}}

<div class="auto-gallery" 
     data-collection="{{ $collection }}" 
     data-batch-size="{{ $batchSize }}">
  
  <div id="photo-grid" class="grid grid-cols-1 sm:grid-cols-2 {{ $columns }} gap-4">
    <!-- Initial batch loaded immediately -->
    {{- range first $batchSize $images -}}
      {{- $filename := .Name -}}
      {{- $imgResource := resources.Get (printf "images/photos/%s/%s" $collection $filename) -}}
      {{- $fullImage := $imgResource -}}
      {{- $thumbnail := $imgResource.Fit "600x600 q85" -}}

      {{- $imageKey := strings.TrimSuffix (path.Ext $filename) $filename -}}
      {{- $meta := index $metadata.photos $imageKey -}}

      <div class="photo-item"
           data-src="{{ $fullImage.RelPermalink }}"
           data-title="{{ if $meta }}{{ $meta.title | default $filename }}{{ else }}{{ $filename }}{{ end }}"
           data-camera="{{ if $meta }}{{ $meta.camera }}{{ end }}"
           data-lens="{{ if $meta }}{{ $meta.lens }}{{ end }}"
           data-location="{{ if $meta }}{{ $meta.location }}{{ end }}"
           data-date="{{ if $meta }}{{ $meta.date }}{{ end }}"
           data-description="{{ if $meta }}{{ $meta.description }}{{ end }}">
        <img src="{{ $thumbnail.RelPermalink }}"
             alt="{{ if $meta }}{{ $meta.title | default $filename }}{{ else }}{{ $filename }}{{ end }}">
      </div>
    {{- end -}}
  </div>
  
  <!-- Hidden images data for infinite scroll -->
  <script type="application/json" id="remaining-photos-data">
    {{- $remainingImages := after $batchSize $images -}}
    {{- $photoData := slice -}}
    {{- range $remainingImages -}}
      {{- $filename := .Name -}}
      {{- $imgResource := resources.Get (printf "images/photos/%s/%s" $collection $filename) -}}
      {{- $fullImage := $imgResource -}}
      {{- $thumbnail := $imgResource.Fit "600x600 q85" -}}

      {{- $imageKey := strings.TrimSuffix (path.Ext $filename) $filename -}}
      {{- $meta := index $metadata.photos $imageKey -}}

      {{- $title := $filename -}}
      {{- $camera := "" -}}
      {{- $lens := "" -}}
      {{- $location := "" -}}
      {{- $date := "" -}}
      {{- $description := "" -}}
      {{- if $meta -}}
        {{- $title = default $filename $meta.title -}}
        {{- $camera = default "" $meta.camera -}}
        {{- $lens = default "" $meta.lens -}}
        {{- $location = default "" $meta.location -}}
        {{- $date = default "" $meta.date -}}
        {{- $description = default "" $meta.description -}}
      {{- end -}}
      {{- $photoInfo := dict
            "src" $fullImage.RelPermalink
            "thumbnail" $thumbnail.RelPermalink
            "filename" $filename
            "title" $title
            "camera" $camera
            "lens" $lens
            "location" $location
            "date" $date
            "description" $description -}}
      {{- $photoData = $photoData | append $photoInfo -}}
    {{- end -}}
    {{- $photoData | jsonify -}}
  </script>
  
  <div id="loading-spinner" class="hidden flex justify-center items-center p-8">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
  </div>
</div>

<!-- Lightbox Modal -->
<div id="photo-modal" class="hidden">
  <button id="close-modal">&times;</button>
  <button id="modal-prev" class="modal-nav">‹</button>
  <button id="modal-next" class="modal-nav">›</button>
  <img id="modal-image" src="" alt="">
  <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 2rem; color: white; z-index: 100000;">
    <h3 id="modal-title" style="font-size: 1.25rem; font-weight: 500; margin-bottom: 0.5rem;"></h3>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
      <p id="modal-camera" style="font-size: 0.875rem; opacity: 0.9;"></p>
      <p id="modal-location" style="font-size: 0.875rem; opacity: 0.7;"></p>
    </div>
    <p id="modal-description" style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.8;"></p>
  </div>
</div>

<script>
// Auto-gallery JavaScript for infinite scroll and lightbox
document.addEventListener('DOMContentLoaded', function() {
  const gallery = document.querySelector('.auto-gallery');
  if (!gallery) return;
  
  const photoGrid = document.getElementById('photo-grid');
  const loadingSpinner = document.getElementById('loading-spinner');
  const modal = document.getElementById('photo-modal');
  const modalImage = document.getElementById('modal-image');
  const modalTitle = document.getElementById('modal-title');
  const modalCamera = document.getElementById('modal-camera');
  const modalLocation = document.getElementById('modal-location');
  const modalDescription = document.getElementById('modal-description');
  const closeModal = document.getElementById('close-modal');
  const modalPrev = document.getElementById('modal-prev');
  const modalNext = document.getElementById('modal-next');

  // Track all photos and current index
  let allPhotos = [];
  let currentPhotoIndex = 0;

  // Get remaining photos data
  let remainingPhotosData = JSON.parse(document.getElementById('remaining-photos-data').textContent || '[]');
  // Handle double-encoding edge case
  if (typeof remainingPhotosData === 'string') {
    remainingPhotosData = JSON.parse(remainingPhotosData);
  }
  // Ensure it's an array
  if (!Array.isArray(remainingPhotosData)) {
    remainingPhotosData = [];
  }
  const batchSize = parseInt(gallery.dataset.batchSize);
  let loadedBatches = 1; // First batch already loaded
  
  // Infinite scroll setup
  if (remainingPhotosData.length > 0) {
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        loadNextBatch();
      }
    }, { threshold: 0.1 });
    
    observer.observe(loadingSpinner);
    loadingSpinner.classList.remove('hidden');
  }
  
  function loadNextBatch() {
    const startIndex = (loadedBatches - 1) * batchSize;
    const batch = remainingPhotosData.slice(startIndex, startIndex + batchSize);
    
    if (batch.length === 0) {
      loadingSpinner.classList.add('hidden');
      return;
    }
    
    batch.forEach(photo => {
      const photoElement = createPhotoElement(photo);
      photoGrid.appendChild(photoElement);
      allPhotos.push(photo);
    });
    
    loadedBatches++;
    
    if (startIndex + batchSize >= remainingPhotosData.length) {
      loadingSpinner.classList.add('hidden');
    }
  }
  
  function createPhotoElement(photo) {
    const div = document.createElement('div');
    div.className = 'photo-item';
    div.dataset.src = photo.src;
    div.dataset.title = photo.title;
    div.dataset.camera = photo.camera;
    div.dataset.lens = photo.lens;
    div.dataset.location = photo.location;
    div.dataset.description = photo.description;

    const img = document.createElement('img');
    img.src = photo.thumbnail || photo.src;
    img.alt = photo.title;
    div.appendChild(img);

    const index = allPhotos.length - 1;
    div.addEventListener('click', () => {
      currentPhotoIndex = index;
      openLightbox(photo);
    });
    return div;
  }
  
  // Build initial photos array
  document.querySelectorAll('.photo-item').forEach((item, index) => {
    const photo = {
      src: item.dataset.src || item.querySelector('img').src,
      title: item.dataset.title,
      camera: item.dataset.camera,
      lens: item.dataset.lens,
      location: item.dataset.location,
      description: item.dataset.description
    };
    allPhotos.push(photo);

    item.addEventListener('click', function() {
      currentPhotoIndex = index;
      openLightbox(photo);
    });
  });
  
  function openLightbox(photo) {
    modalImage.src = photo.src;
    modalTitle.textContent = photo.title || '';
    modalCamera.textContent = photo.camera ? photo.camera + (photo.lens ? ', ' + photo.lens : '') : '';
    modalLocation.textContent = photo.location || '';
    modalDescription.textContent = photo.description || '';
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    updateNavButtons();
  }

  function closeLightboxFn() {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }

  function showNextPhoto() {
    if (currentPhotoIndex < allPhotos.length - 1) {
      currentPhotoIndex++;
      openLightbox(allPhotos[currentPhotoIndex]);
    }
  }

  function showPrevPhoto() {
    if (currentPhotoIndex > 0) {
      currentPhotoIndex--;
      openLightbox(allPhotos[currentPhotoIndex]);
    }
  }

  function updateNavButtons() {
    modalPrev.style.display = currentPhotoIndex > 0 ? 'block' : 'none';
    modalNext.style.display = currentPhotoIndex < allPhotos.length - 1 ? 'block' : 'none';
  }

  closeModal.addEventListener('click', closeLightboxFn);
  modalPrev.addEventListener('click', (e) => { e.stopPropagation(); showPrevPhoto(); });
  modalNext.addEventListener('click', (e) => { e.stopPropagation(); showNextPhoto(); });

  modal.addEventListener('click', function(e) {
    if (e.target === modal || e.target === modalImage) closeLightboxFn();
  });

  document.addEventListener('keydown', function(e) {
    if (!modal.classList.contains('hidden')) {
      if (e.key === 'Escape') closeLightboxFn();
      if (e.key === 'ArrowLeft') showPrevPhoto();
      if (e.key === 'ArrowRight') showNextPhoto();
    }
  });
});
</script>
